<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KIN MUSALA | Elite</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --primary: #FF4B3A; /* Ton rouge bouton exact */
            --bg-start: #1A1C29; /* Ton dégradé haut */
            --bg-end: #0D0E14;   /* Ton dégradé bas */
            --surface: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --text: #FFFFFF;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { 
            background: linear-gradient(180deg, var(--bg-start) 0%, var(--bg-end) 100%); 
            color: var(--text); 
            min-height: 100vh;
        }
        
        /* UI Elements */
        .page { display: none; padding: 20px 5% 100px; max-width: 500px; margin: 0 auto; }
        .page.active { display: block; }
        .btn-primary { background: var(--primary); color: white; border-radius: 15px; border:none; padding:18px; font-weight:700; width:100%; cursor:pointer; }
        .btn-outline { background: #212330; color: white; border-radius: 15px; border:1px solid var(--border); padding:18px; font-weight:700; width:100%; cursor:pointer; margin-top:10px;}
        .field { width:100%; padding:16px; border-radius:12px; background: rgba(0,0,0,0.3); border:1px solid var(--border); color:white; margin-bottom:12px; outline:none; }
        
        /* Cards */
        .card { background: var(--surface); border-radius: 20px; padding: 20px; border: 1px solid var(--border); margin-bottom: 15px; position: relative; }
        .status-badge { background: #FFB800; color: black; padding: 4px 10px; border-radius: 10px; font-size: 0.7rem; font-weight: 800; margin-bottom: 10px; display: inline-block; }

        /* Modal */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:none; align-items:center; justify-content:center; z-index:2000; padding:20px; }
        .modal-card { background: #1A1C29; border-radius: 25px; padding: 30px; width: 100%; text-align: center; border: 1px solid var(--primary); }

        .tab-bar { position: fixed; bottom: 0; width: 100%; height: 70px; background: #0D0E14; border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; z-index:1000; }
        .tab-item { color: gray; font-size: 0.7rem; text-align: center; cursor:pointer; }
        .tab-item.active { color: var(--primary); }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="info-modal" class="modal" onclick="this.style.display='none'">
    <div class="modal-card" onclick="event.stopPropagation()">
        <div id="modal-body"></div>
    </div>
</div>

<div id="hero" class="page active">
    <div style="text-align: center; padding-top: 10vh;">
        <h1 style="font-size: 3.5rem; font-weight: 900; letter-spacing: -2px; line-height:0.9;">KIN<br>MUSALA.</h1>
        <p style="opacity: 0.7; margin: 30px 0 40px; line-height: 1.5;">L'élite des talents de Kinshasa.<br>Sécurisé. Rapide. Professionnel.</p>
        <button class="btn-primary" onclick="startReg('client')">Trouver un Expert</button>
        <button class="btn-outline" onclick="startReg('freelance')">Devenir Freelance</button>
    </div>
</div>

<div id="signup" class="page">
    <h2 style="margin-bottom:20px; text-align:center;">Création du profil</h2>
    <input type="text" id="reg-name" placeholder="Nom complet" class="field">
    <input type="email" id="reg-email" placeholder="Email" class="field">
    <input type="text" id="reg-photo" placeholder="URL de votre photo de profil" class="field">
    <input type="text" id="reg-payment" placeholder="Numéro M-Pesa / Airtel Money" class="field">
    
    <div id="freelance-only" class="hidden">
        <input type="text" id="reg-domain" placeholder="Votre métier (ex: Plombier)" class="field">
        <input type="number" id="reg-exp" placeholder="Années d'expérience" class="field">
    </div>
    
    <button class="btn-primary" id="btn-save">Valider mon inscription</button>
</div>

<div id="explore" class="page">
    <h2 style="margin-bottom:20px;">Talents disponibles</h2>
    <div id="talent-list"></div>
</div>

<div id="chat" class="page">
    <h2 style="margin-bottom:20px;">Missions & Chat</h2>
    <div id="mission-list"></div>
</div>

<div id="tab-bar" class="tab-bar hidden">
    <div class="tab-item active" id="btn-exp" onclick="showPage('explore')"><i class="fa fa-search"></i><br>Explorer</div>
    <div class="tab-item" id="btn-chat" onclick="showPage('chat')"><i class="fa fa-comment"></i><br>Missions</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDX2i_klsx1rdyBWAv5Wp4B4uAQ48nMG6k",
      authDomain: "kin-musala.firebaseapp.com",
      projectId: "kin-musala",
      storageBucket: "kin-musala.firebasestorage.app",
      messagingSenderId: "1055942721226",
      appId: "1:1055942721226:web:a59dffc178245dfba4be33"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let currentUser = null;
    let tempRole = '';

    window.showPage = (id) => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        if(id === 'explore') { loadTalents(); document.getElementById('btn-exp').classList.add('active'); }
        if(id === 'chat') { loadMissions(); document.getElementById('btn-chat').classList.add('active'); }
    };

    window.startReg = (role) => {
        tempRole = role;
        document.getElementById('freelance-only').classList.toggle('hidden', role !== 'freelance');
        showPage('signup');
    };

    document.getElementById('btn-save').onclick = async () => {
        const userData = {
            name: document.getElementById('reg-name').value,
            email: document.getElementById('reg-email').value,
            photo: document.getElementById('reg-photo').value || "https://ui-avatars.com/api/?name=User&background=FF4B3A&color=fff",
            payment: document.getElementById('reg-payment').value,
            role: tempRole,
            domain: document.getElementById('reg-domain').value || "Client",
            exp: document.getElementById('reg-exp').value || 0,
            rating: 4.8
        };
        const docRef = await addDoc(collection(db, "users"), userData);
        currentUser = { id: docRef.id, ...userData };
        document.getElementById('tab-bar').classList.remove('hidden');
        showPage('explore');
    };

    async function loadTalents() {
        const list = document.getElementById('talent-list');
        list.innerHTML = "Chargement...";
        const q = query(collection(db, "users"), where("role", "==", "freelance"));
        const snap = await getDocs(q);
        list.innerHTML = "";
        snap.forEach(d => {
            const u = d.data();
            const div = document.createElement('div');
            div.className = "card";
            div.innerHTML = `
                <div style="display:flex; align-items:center; gap:15px;" onclick="openDetail('${d.id}', '${u.name}', '${u.photo}', '${u.domain}', '${u.exp}', '${u.payment}')">
                    <img src="${u.photo}" style="width:65px; height:65px; border-radius:50%; object-fit:cover; border:2px solid var(--primary);">
                    <div>
                        <h3 style="font-size:1.1rem;">${u.name}</h3>
                        <p style="color:var(--primary); font-size:0.8rem; font-weight:800;">${u.domain}</p>
                    </div>
                </div>`;
            list.appendChild(div);
        });
    }

    window.openDetail = (id, name, photo, domain, exp, payment) => {
        document.getElementById('modal-body').innerHTML = `
            <img src="${photo}" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:3px solid var(--primary); margin-bottom:15px;">
            <h2>${name}</h2>
            <p style="color:var(--primary); font-weight:800;">${domain}</p>
            <div style="text-align:left; background:rgba(0,0,0,0.3); padding:15px; border-radius:15px; margin:15px 0;">
                <p><b>Expérience:</b> ${exp} ans</p>
                <p><b>Note:</b> ⭐ 4.8/5</p>
                <p><b>Paiement:</b> ${payment}</p>
            </div>
            <button class="btn-primary" onclick="commander('${id}', '${name}')">Commander maintenant</button>
        `;
        document.getElementById('info-modal').style.display = 'flex';
    };

    window.commander = async (talentId, talentName) => {
        await addDoc(collection(db, "missions"), {
            clientId: currentUser.id,
            clientName: currentUser.name,
            talentId: talentId,
            talentName: talentName,
            status: "en_attente",
            createdAt: new Date()
        });
        alert("Mission envoyée ! Allez dans l'onglet Missions.");
        document.getElementById('info-modal').style.display = 'none';
        showPage('chat');
    };

    function loadMissions() {
        const list = document.getElementById('mission-list');
        const q = query(collection(db, "missions"));
        onSnapshot(q, (snap) => {
            list.innerHTML = "";
            snap.forEach(d => {
                const m = d.data();
                if(m.clientId === currentUser.id || m.talentId === currentUser.id) {
                    const isTalent = m.talentId === currentUser.id;
                    const div = document.createElement('div');
                    div.className = "card";
                    let actionHtml = '';
                    
                    if(m.status === 'en_attente' && isTalent) {
                        actionHtml = `<button class="btn-primary" onclick="updateM('${d.id}', 'en_cours')">Accepter</button>`;
                    } else if(m.status === 'en_cours') {
                        actionHtml = `<div class="status-badge" style="background:#00E676">TACHE EN COURS</div>
                                      <button class="btn-outline" onclick="updateM('${d.id}', 'termine')">Terminer la mission</button>`;
                    } else if(m.status === 'termine') {
                        actionHtml = `<div class="status-badge" style="background:gray">MISSION TERMINÉE</div>`;
                    }

                    div.innerHTML = `
                        <p style="font-size:0.8rem; opacity:0.6;">Mission avec ${isTalent ? m.clientName : m.talentName}</p>
                        <h3 style="margin:5px 0 15px 0;">Projet de service</h3>
                        ${actionHtml}
                    `;
                    list.appendChild(div);
                }
            });
        });
    }

    window.updateM = async (id, status) => {
        await updateDoc(doc(db, "missions", id), { status: status });
    };

</script>
</body>
</html>

